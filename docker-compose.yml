version: '3.8'

services:
  gateway:
    build:
      context: .
      args:
        VERSION: dev
    image: wg-singbox-gateway:latest
    container_name: wg-singbox-gateway
    restart: unless-stopped

    # Required for WireGuard and networking
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    devices:
      - /dev/net/tun
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv6.conf.all.forwarding=1

    # Port for WireGuard
    ports:
      - "51820:51820/udp"

    # Volume mounts for configuration
    volumes:
      - ./configs:/etc/wg-singbox:ro
      - ./configs/singbox.json:/etc/singbox/config.json:ro
      - wg-configs:/etc/wireguard

    # Environment variables (or use .env file)
    environment:
      - WG_PRIVATE_KEY=${WG_PRIVATE_KEY:-}
      - WG_PUBLIC_KEY=${WG_PUBLIC_KEY:-}
      - PEER1_PUBLIC_KEY=${PEER1_PUBLIC_KEY:-}
      - PEER1_PRESHARED_KEY=${PEER1_PRESHARED_KEY:-}

volumes:
  wg-configs:
